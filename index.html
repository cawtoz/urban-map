<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Leaflet</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="crossorigin=""></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        /* Estilos para los popups de Leaflet */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            border: 1px solid #e0e0e0;
            background: white;
        }
        
        .leaflet-popup-content {
            margin: 0;
            width: 340px !important;
        }
        
        .leaflet-popup-tip {
            background: white;
        }
        
        .leaflet-popup-close-button {
            color: #999 !important;
            font-size: 22px !important;
            padding: 4px 8px !important;
            font-weight: 300 !important;
            width: 28px !important;
            height: 28px !important;
            text-align: center !important;
        }
        
        .leaflet-popup-close-button:hover {
            color: #333 !important;
        }
        
        .media-popup {
            padding: 0;
            background: white;
        }
        
        .media-popup h3 {
            margin: 0;
            padding: 12px 16px;
            background: white;
            color: #1a1a1a;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .media-popup video {
            width: 100%;
            display: block;
            background: #000;
        }
        
        /* Contenedor del mezclador de audio */
        #audio-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            width: 320px;
            max-height: calc(100vh - 40px);
            display: none;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }
        
        #audio-container.active {
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Header del mezclador */
        .mixer-header {
            background: #1a1a1a;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .mixer-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            margin: 0;
            letter-spacing: 0.5px;
        }
        
        .mixer-title i {
            font-size: 14px;
        }
        
        .mixer-close {
            background: transparent;
            border: none;
            width: 26px;
            height: 26px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #ffffff;
            transition: all 0.2s ease;
        }
        
        .mixer-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Lista de pistas de audio */
        .mixer-tracks {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            max-height: 500px;
            background: #fafafa;
        }
        
        .mixer-tracks:empty::after {
            content: "No hay audios en el mezclador";
            display: block;
            text-align: center;
            color: #999;
            padding: 30px 20px;
            font-size: 12px;
        }
        
        /* Cada pista individual */
        .audio-track {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            animation: trackIn 0.2s ease-out;
        }
        
        @keyframes trackIn {
            from {
                transform: translateX(-10px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .track-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .track-name {
            color: #1a1a1a;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }
        
        .track-name i {
            font-size: 12px;
            color: #666;
        }
        
        .track-remove {
            background: transparent;
            border: 1px solid #e0e0e0;
            width: 22px;
            height: 22px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #666;
            transition: all 0.2s ease;
        }
        
        .track-remove:hover {
            background: #f5f5f5;
            border-color: #d0d0d0;
            color: #1a1a1a;
        }
        
        .track-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* Controles de reproducción */
        .play-pause-btn {
            background: #1a1a1a;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            transition: all 0.2s ease;
        }
        
        .play-pause-btn:hover {
            background: #333;
        }
        
        .play-pause-btn:active {
            transform: scale(0.96);
        }
        
        /* Control de volumen */
        .volume-control {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .volume-icon {
            font-size: 14px;
            color: #666;
            width: 16px;
        }
        
        .volume-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #1a1a1a;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #1a1a1a;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .volume-value {
            color: #999;
            font-size: 10px;
            min-width: 28px;
            text-align: right;
        }
        
        /* Barra de progreso */
        .progress-bar {
            width: 100%;
            height: 3px;
            background: #f0f0f0;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .progress-fill {
            height: 100%;
            background: #1a1a1a;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        /* Scrollbar personalizado */
        .mixer-tracks::-webkit-scrollbar {
            width: 6px;
        }
        
        .mixer-tracks::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .mixer-tracks::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 3px;
        }
        
        .mixer-tracks::-webkit-scrollbar-thumb:hover {
            background: #b0b0b0;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Mezclador de audio -->
    <div id="audio-container">
        <div class="mixer-header">
            <h3 class="mixer-title"><i class="fas fa-sliders-h"></i> AUDIO MIXER</h3>
            <button class="mixer-close" onclick="closeAllAudios()"><i class="fas fa-times"></i></button>
        </div>
        <div class="mixer-tracks" id="mixer-tracks"></div>
    </div>
    
    <script>
        // Inicializar el mapa (sin cerrar popup al hacer click)
        const map = L.map('map', {
            closePopupOnClick: false  // No cerrar popups al hacer click en el mapa
        }).setView([4.5970, -74.0720], 15);  // Centro en la zona delimitada
        
        // Agregar capa de tiles de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Cargar la delimitación personalizada desde el archivo JSON
        fetch('delimitation.json')
            .then(response => response.json())
            .then(data => {
                const coordinates = data.features[0].geometry.coordinates[0];
                
                // Convertir coordenadas de [lng, lat] a [lat, lng] para Leaflet
                const polygonCoords = coordinates.map(coord => [coord[1], coord[0]]);
                
                // Dibujar el borde de la zona delimitada
                L.polygon(polygonCoords, {
                    color: '#1a1a1a',
                    weight: 2,
                    fillOpacity: 0,
                    interactive: false
                }).addTo(map);
                
                // Crear máscara oscura fuera de la zona delimitada
                const worldBounds = [
                    [85, -180], [85, 180], [-85, 180], [-85, -180]
                ];
                
                // Invertir el orden para crear el agujero correctamente
                const invertedCoords = [...polygonCoords].reverse();
                
                L.polygon([worldBounds, invertedCoords], {
                    color: 'transparent',
                    fillColor: '#000',
                    fillOpacity: 0.6,
                    interactive: false
                }).addTo(map);
            })
            .catch(error => {
                console.error('Error al cargar la delimitación:', error);
            });
        
        // Referencias al contenedor de audio
        const audioContainer = document.getElementById('audio-container');
        const mixerTracks = document.getElementById('mixer-tracks');
        
        // Variable para rastrear el popup de video abierto y audios activos
        let currentVideoPopup = null;
        let activeAudios = new Map(); // Guarda los audios activos por ID de ubicación
        
        // Función para cerrar todos los audios
        function closeAllAudios() {
            // Restaurar el color de todos los marcadores antes de pausar
            activeAudios.forEach((audioData, locationId) => {
                audioData.audio.pause();
                // Restaurar color del marcador a inactivo
                if (audioData.marker) {
                    updateMarkerStyle(audioData.marker, false);
                }
            });
            activeAudios.clear();
            mixerTracks.innerHTML = '';
            audioContainer.classList.remove('active');
        }
        
        // Función para crear una pista de audio en el mezclador
        function createAudioTrack(location) {
            // Si ya existe una pista para esta ubicación, no crear otra
            if (activeAudios.has(location.id)) {
                return;
            }
            
            // Crear el elemento de la pista
            const trackDiv = document.createElement('div');
            trackDiv.className = 'audio-track';
            trackDiv.dataset.locationId = location.id;
            
            // Crear elemento de audio (oculto)
            const audio = document.createElement('audio');
            audio.src = location.file;
            audio.volume = 0.7;
            
            // Header de la pista
            const trackHeader = document.createElement('div');
            trackHeader.className = 'track-header';
            
            const trackName = document.createElement('div');
            trackName.className = 'track-name';
            trackName.innerHTML = `<i class="fas fa-music"></i> ${location.title}`;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'track-remove';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = function() {
                removeAudioTrack(location.id);
            };
            
            trackHeader.appendChild(trackName);
            trackHeader.appendChild(removeBtn);
            
            // Controles de la pista
            const trackControls = document.createElement('div');
            trackControls.className = 'track-controls';
            
            // Botón de play/pause
            const playPauseBtn = document.createElement('button');
            playPauseBtn.className = 'play-pause-btn';
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playPauseBtn.onclick = function() {
                if (audio.paused) {
                    audio.play();
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                    audio.pause();
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
            };
            
            // Control de volumen
            const volumeControl = document.createElement('div');
            volumeControl.className = 'volume-control';
            
            const volumeIcon = document.createElement('i');
            volumeIcon.className = 'volume-icon fas fa-volume-up';
            
            const volumeSlider = document.createElement('input');
            volumeSlider.type = 'range';
            volumeSlider.className = 'volume-slider';
            volumeSlider.min = '0';
            volumeSlider.max = '100';
            volumeSlider.value = '70';
            volumeSlider.oninput = function() {
                audio.volume = this.value / 100;
                volumeValue.textContent = this.value + '%';
                updateVolumeIcon(volumeIcon, this.value);
            };
            
            const volumeValue = document.createElement('span');
            volumeValue.className = 'volume-value';
            volumeValue.textContent = '70%';
            
            volumeControl.appendChild(volumeIcon);
            volumeControl.appendChild(volumeSlider);
            volumeControl.appendChild(volumeValue);
            
            trackControls.appendChild(playPauseBtn);
            trackControls.appendChild(volumeControl);
            
            // Barra de progreso
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            const progressFill = document.createElement('div');
            progressFill.className = 'progress-fill';
            progressBar.appendChild(progressFill);
            
            // Actualizar progreso
            audio.addEventListener('timeupdate', function() {
                const percent = (audio.currentTime / audio.duration) * 100;
                progressFill.style.width = percent + '%';
            });
            
            // Click en barra de progreso para buscar
            progressBar.onclick = function(e) {
                const rect = progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                audio.currentTime = percent * audio.duration;
            };
            
            // Cuando termina el audio
            audio.addEventListener('ended', function() {
                playPauseBtn.textContent = '▶';
            });
            
            // Ensamblar la pista
            trackDiv.appendChild(trackHeader);
            trackDiv.appendChild(trackControls);
            trackDiv.appendChild(progressBar);
            
            // Agregar al mezclador
            mixerTracks.appendChild(trackDiv);
            audioContainer.classList.add('active');
            
            // Guardar referencia (incluyendo el marcador)
            activeAudios.set(location.id, { 
                element: trackDiv, 
                audio: audio,
                marker: location.marker 
            });
            
            // Actualizar color del marcador a activo
            updateMarkerStyle(location.marker, true);
            
            // Reproducir automáticamente
            audio.play().catch(err => console.log('Error al reproducir:', err));
        }
        
        // Función para actualizar el icono de volumen
        function updateVolumeIcon(icon, value) {
            // Limpiar clases existentes
            icon.className = 'volume-icon';
            
            if (value == 0) {
                icon.classList.add('fas', 'fa-volume-mute');
            } else if (value < 50) {
                icon.classList.add('fas', 'fa-volume-down');
            } else {
                icon.classList.add('fas', 'fa-volume-up');
            }
        }
        
        // Función para eliminar una pista de audio
        function removeAudioTrack(locationId) {
            const audioData = activeAudios.get(locationId);
            if (audioData) {
                audioData.audio.pause();
                audioData.element.remove();
                
                // Restaurar color del marcador a inactivo
                if (audioData.marker) {
                    updateMarkerStyle(audioData.marker, false);
                }
                
                activeAudios.delete(locationId);
                
                // Ocultar mezclador si no hay más audios
                if (activeAudios.size === 0) {
                    audioContainer.classList.remove('active');
                }
            }
        }
        
        // Función para actualizar el estilo del marcador
        function updateMarkerStyle(marker, isActive) {
            const iconElement = marker.getElement();
            if (iconElement) {
                const circle = iconElement.querySelector('div');
                if (circle) {
                    if (isActive) {
                        // Estilo activo - verde
                        circle.style.borderColor = '#10b981';
                        circle.style.background = '#d1fae5';
                        circle.style.color = '#10b981';
                    } else {
                        // Estilo inactivo - gris
                        circle.style.borderColor = '#666';
                        circle.style.background = 'white';
                        circle.style.color = '#666';
                    }
                }
            }
        }
        
        // Cargar ubicaciones desde el JSON
        fetch('locations.json')
            .then(response => response.json())
            .then(locations => {
                locations.forEach(location => {
                    // Crear icono personalizado según el tipo
                    let iconHTML = '';
                    let iconColor = '';
                    
                    if (location.type === 'video') {
                        iconHTML = '<i class="fas fa-video"></i>';
                        iconColor = '#1a1a1a';
                    } else if (location.type === 'audio') {
                        iconHTML = '<i class="fas fa-music"></i>';
                        iconColor = '#666';
                    }
                    
                    // Crear icono personalizado para Leaflet
                    const customIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `
                            <div style="
                                background: white;
                                border: 2px solid ${iconColor};
                                border-radius: 50%;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                                color: ${iconColor};
                                font-size: 16px;
                            ">
                                ${iconHTML}
                            </div>
                        `,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20],
                        popupAnchor: [0, -20]
                    });
                    
                    // Crear marcador con icono personalizado
                    const marker = L.marker([location.lat, location.lng], { icon: customIcon }).addTo(map);
                    
                    // Guardar referencia del marcador en la ubicación
                    location.marker = marker;
                    
                    // Crear contenido del popup solo para videos
                    if (location.type === 'video') {
                        const mediaHTML = `
                            <div class="media-popup">
                                <h3>${location.title}</h3>
                                <video controls autoplay>
                                    <source src="${location.file}" type="video/mp4">
                                    Tu navegador no soporta el elemento de video.
                                </video>
                            </div>
                        `;
                        
                        // Vincular popup solo a marcadores de video
                        marker.bindPopup(mediaHTML, {
                            closeButton: true,      // Mostrar botón X
                            autoClose: false,       // No cerrar automáticamente al abrir otro popup
                            closeOnClick: false     // No cerrar al hacer click en el mapa
                        });
                        
                        // Guardar referencia cuando se abre un popup de video
                        marker.on('popupopen', function() {
                            // Si hay otro video abierto, cerrarlo
                            if (currentVideoPopup && currentVideoPopup !== marker) {
                                currentVideoPopup.closePopup();
                            }
                            currentVideoPopup = marker;
                        });
                        
                        // Limpiar referencia cuando se cierra
                        marker.on('popupclose', function() {
                            if (currentVideoPopup === marker) {
                                currentVideoPopup = null;
                            }
                        });
                    }
                    
                    // Al hacer click, manejar la reproducción
                    marker.on('click', function(e) {
                        if (location.type === 'audio') {
                            // Prevenir el comportamiento por defecto del marcador
                            e.originalEvent.preventDefault();
                            e.originalEvent.stopPropagation();
                            
                            // Prevenir que Leaflet cierre otros popups
                            L.DomEvent.stopPropagation(e);
                            
                            // Agregar audio al mezclador sin afectar popups abiertos
                            createAudioTrack(location);
                            
                            // No abrir popup para audios
                            return false;
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Error al cargar las ubicaciones:', error);
            });
    </script>
</body>
</html>
